<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" crossorigin="anonymous"></script>
    <script src="./handlers.js"></script>
    <script src="./zeichner.js"></script>
    <style>
        html {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: darkslategrey;
            color: white;
        }

        table {
            border-collapse: collapse;
        }

        th, td {
            border: 1.5px solid white;
            padding: 10px;
        }

        button {
            padding: 5px;
        }
    </style>
    <title>Hello World</title>
</head>
<body>
    <div id="menu">
        Menu
        <input id="name" type="text" placeholder="Name">
        <input id="runden" type="number" min="0" max="14" placeholder="Runden">
        <button onclick="onSpielErstellen()">Spiel erstellen</button>
        <div id="raeume"></div>
    </div>
    <div id="lobby">
        Lobby
        <ul></ul>
        <button onclick="onBotHinzufuegen()">Bot hinzufügen</button>
        <button onclick="onSpielStart()">Start</button>
    </div>
    <div id="spiel">
        Spiel
        Runde: (<span id="runde"></span>)
        <table></table>
        Trumpffarbe: <span id="trumpffarbe"></span> <br>
        Stich:
        <ol>
        </ol>
        <div id="trumpf">
            <button onclick="onTrumpf('rot')">ROT</button>
            <button onclick="onTrumpf('gruen')">GRÜN</button>
            <button onclick="onTrumpf('blau')">BLAU</button>
            <button onclick="onTrumpf('gelb')">GELB</button>
        </div>
        <div id="vorhersage">
            <input type="number" min="0" placeholder="Vorhersage">
            <button onclick="onVorhersage()">Fertig</button>
        </div>
        Hand:<br>
        <div id="hand"></div>
        <button id="weiter" onclick="onWeiter()">Weiter</button>
    </div>
    <div id="ende">
        <table></table>
        <button>Beenden</button>
    </div>
    <script>
        let _id = ''
        let _spiel = {}
        let _hand = []
        let _warte = false

        $('#lobby').hide()
        $('#spiel').hide()
        $('#ende').hide()
        $('#weiter').hide()
        
        const socket = io();
        socket.on('id', (id) => {_id = id})
        socket.on('spiel', (spiel) => {
            if (_warte) {
                _spiel = spiel
                $('#weiter').show()
            } else {
                if (spiel.ausloeser == 'rundeBeendet') {
                    spiel.runde = spiel.runden.at(-1).runde
                    spiel.runde.stich = spiel.runde.stiche.at(-1).stich
                    _warte = true
                    $('#weiter').show()
                } else if (spiel.ausloeser == 'stichBeendet') {
                    spiel.runde.stich = spiel.runde.stiche.at(-1).stich
                    _warte = true
                    $('#weiter').show()
                }
                zeichneSpiel(spiel)
            }
        })
        socket.on('hand', hand => {
            _hand = hand
        })
        socket.on('raeume', raeume => {
            $('#raeume').html(raeume.map(([id, raum]) =>
                `<button onclick=onSpielBeitreten('${id}')>${raum}</button>`
            ))
        })

        function zeichneSpiel(spiel) {
            $('#menu').hide()
            $('#lobby').hide()
            $('#spiel').hide()
            $('#trumpf').hide()
            $('#vorhersage').hide()
            $('#hand').hide()
            $('#ende').hide()

            if (spiel.erwarte == 'start') {
                $('#lobby').show()
                $('#lobby ul').html(spiel.spieler.map(({name}) => `<li>${name}</li>`))
            } else if (spiel.erwarte == 'ende') {
                $('#ende').show()
                $('#ende table').html(getEndeHtml(spiel))
            } else {
                $('#spiel').show()
                const runde = spiel.runde
                $('#runde').html(`${runde.rundenNummer} / ${spiel.rundenAnzahl}`)
                $('#spiel table').html(getSpielerTabelleHtml(spiel))
                $('#trumpffarbe').html(runde.trumpffarbe.replace('ue', 'ü').toUpperCase())
                $('#spiel ol').html(getStichHtml(runde.stich))

                if (runde.aktiverSpieler.id == _id && !_warte) {
                    if(spiel.erwarte == 'vorhersage') {
                        $('#vorhersage').show()
                    } else if (spiel.erwarte == 'trumpf') {
                        $('#trumpf').show()
                    }
                }

                $('#hand').show()
                $('#hand').html(getHandHtml(spiel, _hand))
            }
        }

        function onWeiter() {
            _warte = false;
            $('#weiter').hide()
            zeichneSpiel(_spiel);
        }
    </script>
</body>
</html>